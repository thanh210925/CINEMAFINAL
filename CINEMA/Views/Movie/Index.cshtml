@model IEnumerable<CINEMA.Models.Movie>

@{
    ViewData["Title"] = "Quản lý phim";
    Layout = "_AdminLayout";

    var comingSoon = Model?
        .Where(m => m.ReleaseDate.HasValue &&
                    m.ReleaseDate.Value.ToDateTime(TimeOnly.MinValue) > DateTime.Today)
        .ToList() ?? new();

    var endedMovies = Model?
        .Where(m => m.IsActive == false)
        .ToList() ?? new();
}

<div class="container-fluid py-4">

    <!-- 🧭 Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">
            <i class="bi bi-film me-2"></i> Quản lý phim
        </h2>
        <a asp-action="Create" class="btn btn-success btn-lg shadow-sm">
            <i class="bi bi-plus-circle me-2"></i> Thêm phim mới
        </a>
    </div>

    <!-- Thông báo -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success fw-semibold shadow-sm">
            @TempData["SuccessMessage"]
        </div>
    }

    <!-- 🎬 PHIM ĐANG CHIẾU -->
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-dark text-white fw-semibold">
            🎬 Phim đang chiếu
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">

                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">Poster</th>
                            <th>Tên phim</th>
                            <th>Thời lượng</th>
                            <th>Khởi chiếu</th>
                            <th>Quốc gia</th>
                            <th>Ngôn ngữ</th>
                            <th>Độ tuổi</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>

                        @foreach (var m in Model.Where(m =>
                                                m.IsActive == true &&
                                                m.ReleaseDate.HasValue &&
                                                m.ReleaseDate.Value.ToDateTime(TimeOnly.MinValue) <= DateTime.Today))
                        {
                            <tr>
                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(m.PosterUrl))
                                    {
                                        <img src="@m.PosterUrl" class="rounded shadow-sm"
                                             style="width:60px;height:80px;object-fit:cover;" />
                                    }
                                    else
                                    {

                                        <span class="text-muted">N/A</span>
                                    }
                                </td>

                                <td class="fw-semibold">@m.Title</td>
                                <td>@(m.Duration.HasValue? m.Duration + " phút" : "-")</td>
                                <td>@m.ReleaseDate?.ToString("dd/MM/yyyy")</td>
                                <td>@m.Country</td>
                                <td>@m.Language</td>
                                <td>@m.AgeRating</td>

                                <td><span class="badge bg-success">Đang chiếu</span></td>

                                <td class="text-center">
                                    <div class="btn-group">
                                        <a asp-action="Details" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a>

                                        <a asp-action="Edit" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil-square"></i></a>

                                        <a asp-action="Delete" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('Xóa phim @m.Title?');">
                                            <i class="bi bi-trash"></i>
                                        </a>

                                        @if (!string.IsNullOrEmpty(m.TrailerUrl))
                                        {
                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#trailerModal"
                                                    data-trailer="@m.TrailerUrl"
                                                    data-title="@m.Title">
                                                <i class="bi bi-play-circle"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }

                    </tbody>
                </table>

            </div>
        </div>
    </div>

    <!-- 🚀 PHIM SẮP CHIẾU -->
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-secondary text-white fw-semibold">
            🚀 Phim sắp chiếu
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">

                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">Poster</th>
                            <th>Tên phim</th>
                            <th>Thời lượng</th>
                            <th>Khởi chiếu</th>
                            <th>Quốc gia</th>
                            <th>Ngôn ngữ</th>
                            <th>Độ tuổi</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var m in comingSoon)
                        {
                            <tr>
                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(m.PosterUrl))
                                    {
                                        <img src="@m.PosterUrl" class="rounded shadow-sm"
                                             style="width:60px;height:80px;object-fit:cover;" />
                                    }
                                    else
                                    {

                                        <span class="text-muted">N/A</span>
                                    }
                                </td>

                                <td class="fw-semibold">@m.Title</td>
                                <td>@(m.Duration.HasValue? m.Duration + " phút" : "-")</td>
                                <td>@m.ReleaseDate?.ToString("dd/MM/yyyy")</td>
                                <td>@m.Country</td>
                                <td>@m.Language</td>
                                <td>@m.AgeRating</td>

                                <td><span class="badge bg-warning text-dark">Sắp chiếu</span></td>

                                <td class="text-center">
                                    <div class="btn-group">
                                        <a asp-action="Details" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a>

                                        <a asp-action="Edit" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil-square"></i></a>

                                        <a asp-action="Delete" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('Xóa phim @m.Title?');">
                                            <i class="bi bi-trash"></i>
                                        </a>

                                        @if (!string.IsNullOrEmpty(m.TrailerUrl))
                                        {
                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#trailerModal"
                                                    data-trailer="@m.TrailerUrl"
                                                    data-title="@m.Title">
                                                <i class="bi bi-play-circle"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>

            </div>
        </div>
    </div>

    <!-- ❌ PHIM NGƯNG CHIẾU -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-danger text-white fw-semibold">
            ❌ Phim ngưng chiếu
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">

                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">Poster</th>
                            <th>Tên phim</th>
                            <th>Thời lượng</th>
                            <th>Khởi chiếu</th>
                            <th>Quốc gia</th>
                            <th>Ngôn ngữ</th>
                            <th>Độ tuổi</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var m in endedMovies)
                        {
                            <tr>
                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(m.PosterUrl))
                                    {
                                        <img src="@m.PosterUrl" class="rounded shadow-sm"
                                             style="width:60px;height:80px;object-fit:cover;" />
                                    }
                                    else
                                    {

                                        <span class="text-muted">N/A</span>
                                    }
                                </td>

                                <td class="fw-semibold">@m.Title</td>
                                <td>@(m.Duration.HasValue? m.Duration + " phút" : "-")</td>
                                <td>@m.ReleaseDate?.ToString("dd/MM/yyyy")</td>
                                <td>@m.Country</td>
                                <td>@m.Language</td>
                                <td>@m.AgeRating</td>

                                <td><span class="badge bg-danger">Ngưng chiếu</span></td>

                                <td class="text-center">
                                    <div class="btn-group">

                                        <a asp-action="Details" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a>

                                        <a asp-action="Edit" asp-route-id="@m.MovieId"
                                           class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil-square"></i></a>

                                        <form asp-action="Activate" asp-route-id="@m.MovieId" method="post">
                                            <button type="submit" class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                        </form>

                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>

            </div>
        </div>
    </div>

</div>


<!-- 🎥 Modal Trailer -->
<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 overflow-hidden">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="trailerLabel">🎞 Trailer phim</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="trailerFrame" src="" allowfullscreen class="border-0"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('trailerModal');
            const frame = document.getElementById('trailerFrame');
            const title = document.getElementById('trailerLabel');

            modal.addEventListener('show.bs.modal', function (event) {
                const btn = event.relatedTarget;
                const url = btn.getAttribute('data-trailer');
                const movie = btn.getAttribute('data-title');
                let embed = "";

                if (url.includes("youtube.com") || url.includes("youtu.be")) {
                    let id = "";
                    if (url.includes("v=")) id = url.split("v=")[1].split("&")[0];
                    else if (url.includes("youtu.be/")) id = url.split("youtu.be/")[1].split("?")[0];

                    embed = `https://www.youtube.com/embed/${id}?autoplay=1`;
                } else embed = url;

                frame.src = embed;
                title.textContent = "🎬 Trailer – " + movie;
            });

            modal.addEventListener('hidden.bs.modal', function () {
                frame.src = "";
            });
        });
    </script>
}
